<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locker Selection</title>
    <style>
        /* Style for adding text labels */
        .locker-container {
            position: relative;
            display: inline-block;
        }
        .locker-text {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            color: red;
            text-shadow: 1px 1px 2px white;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 4px;
            border-radius: 4px;
        }
    </style>
    <script>
        async function fetchLockerAvailability() {
            try {
                let response = await fetch("https://cboulay07.github.io/locker-selection/lockers.json");
                let lockers = await response.json();

                let img = document.getElementById("lockerMap");
                let ctx = document.createElement("canvas").getContext("2d");
                let imgObj = new Image();
                imgObj.src = img.src;

                imgObj.onload = function() {
                    let canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(imgObj, 0, 0);

                    document.querySelectorAll("area").forEach(area => {
                        let lockerID = area.getAttribute("alt");

                        if (lockers[lockerID] === "unavailable") {
                            area.removeAttribute("onclick"); // Disable click event
                            area.removeAttribute("href"); // Prevent accidental navigation

                            // Get coordinates from image map
                            let coords = area.getAttribute("coords").split(",");
                            let x = parseInt(coords[0]);
                            let y = parseInt(coords[1]);
                            let width = parseInt(coords[2]) - x;
                            let height = parseInt(coords[3]) - y;

                            // Apply a semi-transparent red overlay
                            ctx.fillStyle = "rgba(255, 0, 0, 0.4)";
                            ctx.fillRect(x, y, width, height);

                            // Add "VENDU" text
                            ctx.fillStyle = "red";
                            ctx.font = "bold 16px Arial";
                            ctx.textAlign = "center";
                            ctx.fillText("VENDU", x + width / 2, y + height / 2);
                        }
                    });

                    img.src = canvas.toDataURL();
                };
            } catch (error) {
                console.error("Error fetching locker data:", error);
            }
        }

        function selectLocker(lockerID) {
            let jotformURL = "https://form.jotform.com/250346205562047?selected_locker=" + lockerID;

            // If inside an iframe, break out and redirect full page
            if (window.top !== window.self) {
                window.top.location.replace(jotformURL);
            } else {
                window.location.replace(jotformURL);
            }
        }

        // Load locker availability when the page is ready
        window.onload = fetchLockerAvailability;
    </script>
</head>
<body>
    <h2>Select an Available Locker</h2>
    <div class="locker-container">
        <img id="lockerMap" src="Casier.png" usemap="#image-map">
    </div>

    <map name="image-map">
        <area shape="rect" coords="231,309,285,325" alt="R-15" title="R-15" href="#" onclick="selectLocker('R-15'); return false;">
        <area shape="rect" coords="290,310,345,325" alt="R-14" title="R-14" href="#" onclick="selectLocker('R-14'); return false;">
        <area shape="rect" coords="350,310,405,325" alt="R-13" title="R-13" href="#" onclick="selectLocker('R-13'); return false;">
    </map>
</body>
</html>
