<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locker Selection</title>
    <style>
        /* Style for graying out unavailable lockers */
        .disabled {
            filter: grayscale(100%) brightness(70%);
            pointer-events: none; /* Completely disable clicking */
        }
    </style>
    <script>
        async function fetchLockerAvailability() {
            try {
                let response = await fetch("https://cboulay07.github.io/locker-selection/lockers.json");
                let lockers = await response.json();

                document.querySelectorAll("area").forEach(area => {
                    let lockerID = area.getAttribute("alt");

                    if (lockers[lockerID] === "unavailable") {
                        area.removeAttribute("onclick");  // Disable click event
                        area.removeAttribute("href");  // Prevent accidental navigation
                    }
                });

                // Apply gray-out effect to the image itself for unavailable lockers
                let img = document.getElementById("lockerMap");
                let ctx = document.createElement("canvas").getContext("2d");
                let imgObj = new Image();
                imgObj.src = img.src;
                
                imgObj.onload = function() {
                    let canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    let ctx = canvas.getContext("2d");
                    ctx.drawImage(imgObj, 0, 0);

                    // Loop through unavailable lockers and apply gray effect
                    Object.keys(lockers).forEach(lockerID => {
                        if (lockers[lockerID] === "unavailable") {
                            let lockerArea = document.querySelector(`area[alt="${lockerID}"]`);
                            if (lockerArea) {
                                let coords = lockerArea.getAttribute("coords").split(",");
                                let x = parseInt(coords[0]);
                                let y = parseInt(coords[1]);
                                let width = parseInt(coords[2]) - x;
                                let height = parseInt(coords[3]) - y;

                                // Apply a semi-transparent gray overlay
                                ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                                ctx.fillRect(x, y, width, height);
                            }
                        }
                    });

                    img.src = canvas.toDataURL();
                };
            } catch (error) {
                console.error("Error fetching locker data:", error);
            }
        }

        function selectLocker(lockerID) {
            let jotformURL = "https://form.jotform.com/250346205562047?selected_locker=" + lockerID;

            // Ensure the full page refreshes, breaking out of Jotform iframe
            if (window.top !== window.self) {
                window.top.location.replace(jotformURL);
            } else {
                window.location.replace(jotformURL);
            }
        }

        // Load locker availability when the page is ready
        window.onload = fetchLockerAvailability;
    </script>
</head>
<body>
    <h2>Select an Available Locker</h2>
    <img id="lockerMap" src="Casier.png" usemap="#image-map">

    <map name="image-map">
        <area shape="rect" coords="231,309,285,325" alt="R-15" title="R-15" href="#" onclick="selectLocker('R-15'); return false;">
        <area shape="rect" coords="290,310,345,325" alt="R-14" title="R-14" href="#" onclick="selectLocker('R-14'); return false;">
        <area shape="rect" coords="350,310,405,325" alt="R-13" title="R-13" href="#" onclick="selectLocker('R-13'); return false;">
    </map>
</body>
</html>

